<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perfect Tree View — SVG Connectors</title>
  <style>
    :root{
      --rail-x: 24;           /* left rail x (in px) */
      --hgap: 18;             /* horizontal connector length (px) */
      --stroke: 2;            /* connector thickness (px) */
      --color: #94a3b8;       /* connector color (slate-400) */

      --bg:   #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted:#475569;
      --radius: 12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font: 16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      color:var(--text);
      background:var(--bg);
      padding:24px;
    }
    .wrap{max-width:1120px;margin:0 auto}
    .title{margin:0 0 8px;font-size:24px;font-weight:700}
    .sub{margin:0 0 16px;color:var(--muted)}

    /* ===== TREE ===== */
    .tree{
      background:var(--card);
      border:1px solid #e2e8f0;
      border-radius:var(--radius);
      padding:16px;
      box-shadow:0 1px 2px rgba(2,6,23,.05);
    }
    .t-ul{
      list-style:none;
      margin:0;
      padding-left: calc(var(--rail-x) * 1px + var(--hgap) * 1px + 8px);
      position:relative;
    }
    /* SVG layer lives absolutely inside UL */
    .t-svg{
      position:absolute;
      left:0; top:0;
      pointer-events:none;
      overflow:visible;
    }
    .t-li{ margin:0; padding:0; }
    .t-row{
      position:relative;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
      transition:background .15s ease;
    }
    .t-row:hover{ background:#f1f5f9; }

    /* summary/reset */
    details{ display:block }
    summary{
      list-style:none; cursor:pointer; outline:none;
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:10px;
      transition:background .15s ease;
    }
    summary:hover{ background:#f1f5f9; }
    summary::-webkit-details-marker{ display:none }

    .caret{
      width:10px; height:10px;
      border-right:2px solid #64748b;
      border-bottom:2px solid #64748b;
      transform:rotate(-45deg);
      transition:transform .18s ease;
    }
    details[open] > summary .caret{ transform:rotate(45deg) }

    .badge{
      margin-left:auto;
      font-size:12px; padding:2px 8px;
      border-radius:999px; background:#eef2ff; color:#3730a3;
    }
    .meta{ font-size:12px;color:var(--muted) }

    .dot{ width:10px;height:10px;border-radius:999px;background:#94a3b8 }
    .ok{background:#22c55e}.warn{background:#f59e0b}.fail{background:#ef4444}

    @media (max-width:640px){
      :root{ --rail-x: 20; --hgap: 14; }
      .title{font-size:20px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Perfect Tree View</h1>
    <p class="sub">SVG connectorlar bilan: <strong>mukammal chiziqlar</strong>, <strong>cheksiz chuqurlik</strong>, <strong>collapse/expand</strong>. Dinamik balandliklarda ham chiziqlar to'g'ri tutashadi.</p>

    <div class="tree" data-tree>
      <ul class="t-ul">
        <li class="t-li">
          <details open>
            <summary>
              <span class="caret"></span>
              <strong>Infrastructure</strong>
              <span class="badge">12 checks</span>
            </summary>
            <ul class="t-ul">
              <li class="t-li">
                <details open>
                  <summary>
                    <span class="caret"></span>
                    Operating System
                    <span class="meta">• 3/3 passed</span>
                  </summary>
                  <ul class="t-ul">
                    <li class="t-li">
                      <div class="t-row">
                        <span class="dot ok"></span>
                        OS version is up to date
                        <span class="meta">Critical</span>
                      </div>
                    </li>
                    <li class="t-li">
                      <div class="t-row">
                        <span class="dot ok"></span>
                        Security patches installed
                        <span class="meta">High</span>
                      </div>
                    </li>
                    <li class="t-li">
                      <div class="t-row">
                        <span class="dot ok"></span>
                        Unnecessary services disabled
                        <span class="meta">Medium</span>
                      </div>
                    </li>
                  </ul>
                </details>
              </li>

              <li class="t-li">
                <details open>
                  <summary>
                    <span class="caret"></span>
                    Network
                    <span class="meta">• 3/4 passed</span>
                  </summary>
                  <ul class="t-ul">
                    <li class="t-li"><div class="t-row"><span class="dot ok"></span>Firewall is active <span class="meta">Critical</span></div></li>
                    <li class="t-li"><div class="t-row"><span class="dot warn"></span>Unnecessary ports open <span class="meta">Medium</span></div></li>
                    <li class="t-li"><div class="t-row"><span class="dot ok"></span>NTP configured <span class="meta">Low</span></div></li>
                    <li class="t-li">
                      <details>
                        <summary>
                          <span class="caret"></span>
                          Subnets
                          <span class="meta">• 2 items</span>
                        </summary>
                        <ul class="t-ul">
                          <li class="t-li"><div class="t-row"><span class="dot ok"></span>10.0.0.0/24 internal</div></li>
                          <li class="t-li"><div class="t-row"><span class="dot fail"></span>172.16.0.0/16 guest – ACL missing</div></li>
                        </ul>
                      </details>
                    </li>
                  </ul>
                </details>
              </li>

              <li class="t-li">
                <details>
                  <summary>
                    <span class="caret"></span>
                    Storage
                    <span class="meta">• 2/5 passed</span>
                  </summary>
                  <ul class="t-ul">
                    <li class="t-li"><div class="t-row"><span class="dot ok"></span>Disk encryption enabled <span class="meta">Critical</span></div></li>
                    <li class="t-li"><div class="t-row"><span class="dot fail"></span>Backup configuration valid <span class="meta">High</span></div></li>
                    <li class="t-li"><div class="t-row"><span class="dot fail"></span>Sufficient disk space <span class="meta">Medium</span></div></li>
                  </ul>
                </details>
              </li>
            </ul>
          </details>
        </li>

        <li class="t-li">
          <details>
            <summary>
              <span class="caret"></span>
              <strong>Database</strong>
              <span class="badge">8 checks</span>
            </summary>
            <ul class="t-ul">
              <li class="t-li"><div class="t-row"><span class="dot ok"></span>Default accounts removed</div></li>
              <li class="t-li"><div class="t-row"><span class="dot warn"></span>TLS in transit</div></li>
              <li class="t-li">
                <details>
                  <summary>
                    <span class="caret"></span>
                    Replication
                    <span class="meta">• 2 nodes</span>
                  </summary>
                  <ul class="t-ul">
                    <li class="t-li"><div class="t-row"><span class="dot ok"></span>Primary – healthy</div></li>
                    <li class="t-li"><div class="t-row"><span class="dot warn"></span>Secondary – lag 32s</div></li>
                  </ul>
                </details>
              </li>
            </ul>
          </details>
        </li>
      </ul>
    </div>
  </div>

  <script>
    /**
     * Draw perfect connectors using SVG.
     * For each UL.t-ul:
     *  - Draw a vertical rail from top to midpoint of the last visible LI row.
     *  - Draw a horizontal connector for each direct child LI row.
     */
    (function(){
      const railX = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--rail-x')) || 24;
      const hgap  = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--hgap')) || 18;
      const stroke = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--stroke')) || 2;
      const color  = getComputedStyle(document.documentElement).getPropertyValue('--color') || '#94a3b8';

      function ensureSvg(ul){
        let svg = ul.querySelector(':scope > svg.t-svg');
        if(!svg){
          svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
          svg.classList.add('t-svg');
          svg.setAttribute('width', (railX + hgap + 1));
          svg.setAttribute('height', ul.scrollHeight);
          svg.setAttribute('viewBox', `0 0 ${railX + hgap + 1} ${ul.scrollHeight}`);
          svg.innerHTML = '';
          ul.prepend(svg);
        }
        return svg;
      }

      function midpointY(row, relativeTo){
        const r = row.getBoundingClientRect();
        const p = relativeTo.getBoundingClientRect();
        return (r.top - p.top) + (r.height / 2);
      }

      function layoutUL(ul){
        const svg = ensureSvg(ul);
        svg.setAttribute('height', ul.scrollHeight);
        svg.setAttribute('viewBox', `0 0 ${railX + hgap + 1} ${ul.scrollHeight}`);
        while (svg.firstChild) svg.removeChild(svg.firstChild);

        const lis = Array.from(ul.children).filter(el => el.classList.contains('t-li') && el.offsetParent !== null);
        if(lis.length === 0) return;

        // Collect row midpoints
        const rows = [];
        lis.forEach(li => {
          // the 'row' is either summary (if details) or .t-row
          let row = li.querySelector(':scope > .t-row') || li.querySelector(':scope > details > summary');
          if(row && row.offsetParent !== null){
            rows.push(row);
          }
        });

        if(rows.length === 0) return;

        const lastMid = midpointY(rows[rows.length - 1], ul);

        // Vertical rail
        const rail = document.createElementNS('http://www.w3.org/2000/svg','line');
        rail.setAttribute('x1', railX);
        rail.setAttribute('y1', '0');
        rail.setAttribute('x2', railX);
        rail.setAttribute('y2', String(lastMid));
        rail.setAttribute('stroke', color.trim());
        rail.setAttribute('stroke-width', stroke);
        rail.setAttribute('stroke-linecap', 'round');
        svg.appendChild(rail);

        // Horizontal connectors
        rows.forEach(row => {
          const y = midpointY(row, ul);
          const h = document.createElementNS('http://www.w3.org/2000/svg','line');
          h.setAttribute('x1', railX);
          h.setAttribute('y1', String(y));
          h.setAttribute('x2', String(railX + hgap));
          h.setAttribute('y2', String(y));
          h.setAttribute('stroke', color.trim());
          h.setAttribute('stroke-width', stroke);
          h.setAttribute('stroke-linecap', 'round');
          svg.appendChild(h);
        });
      }

      function layoutTree(root){
        const uls = root.querySelectorAll('.t-ul');
        uls.forEach(ul => layoutUL(ul));
      }

      // Initial layout
      const trees = document.querySelectorAll('[data-tree]');
      trees.forEach(tree => layoutTree(tree));

      // Re-layout on resize
      let ro;
      if('ResizeObserver' in window){
        ro = new ResizeObserver(entries => {
          for (const entry of entries){
            const tree = entry.target.closest('[data-tree]');
            if(tree) layoutTree(tree);
          }
        });
        trees.forEach(tree => ro.observe(tree));
        window.addEventListener('resize', () => trees.forEach(tree => layoutTree(tree)));
      } else {
        window.addEventListener('resize', () => trees.forEach(tree => layoutTree(tree)));
      }

      // Re-layout on toggle (details expand/collapse)
      document.addEventListener('toggle', (e) => {
        if(e.target.tagName.toLowerCase() === 'details'){
          const tree = e.target.closest('[data-tree]');
          if(tree) layoutTree(tree);
        }
      }, true);

      // Re-layout on DOM mutations (add/remove nodes dynamically)
      const mo = new MutationObserver(() => trees.forEach(tree => layoutTree(tree)));
      trees.forEach(tree => mo.observe(tree, {childList:true, subtree:true}));
    })();
  </script>
</body>
</html>
